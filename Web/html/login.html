<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - InversionesSolug C.A.</title>
    <link rel="stylesheet" href="../css/login.css">
</head>
<body>
    <header class="header">
        <div class="logo">
            <img src="../img/WhatsApp Image 2025-07-04 at 4.20.48 PM-Photoroom (1) (1) (1) (1).png" alt="InversionesSolug C.A.">
            <span class="logo-text">InversionesSolug C.A.</span>
        </div>
        <div class="contact-info">
            <a href="../index.html"><img src="../img/png-transparent-house-computer-icons-green-home-home-renovation-angle-building-text-thumbnail-Photoroom.png" alt="Inicio"></a>
        </div>
    </header>

    <main>
        <div class="login-container">
            <h1>Bienvenido</h1>
            <h2>Ingresa a tu Usuario</h2>
            <form id="loginForm">
                <div class="form-group">
                    <input type="text" id="username" name="username" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" id="password" name="password" placeholder="Contraseña" required>
                </div>
                <button type="submit" class="submit-btn">Ingresar</button>
                <a href="./registro.html" class="submit-btn1">Registrarse</a>
                <div id="errorMessage" class="error-message"></div>
            </form>
        </div>
    </main>

    <footer class="footer">
        <p class="copyright">&copy; 2025 InversionesSolug C.A. Todos los derechos reservados.</p>
    </footer>

    <script>
        // Configura la URL de tu API (ajusta si tu ruta es distinta)
        const API_URL = 'http://localhost:3008/api/login';

        // Mapeo de roles numéricos a rutas (1=admin, 2=trab, 3=user)
        const rutasPorRol = {
            1: './admin.html',
            2: './trab.html',
            3: './user.html'
        };

        // Función para mostrar mensaje de error
        function mostrarError(mensaje) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = mensaje;
            errorDiv.style.display = 'block';

            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Manejar el envío del formulario
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const username = document.getElementById('us ername').value.trim();
            const password = document.getElementById('password').value;

            if (!username || !password) {
                mostrarError('Por favor, completa todos los campos.');
                return;
            }

            try {
                const res = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    // enviar campos que acepta el backend: userId y pass
                    body: JSON.stringify({ userId: username, pass: password })
                });
                
                if (!res.ok) {
                    // Si la API devuelve 4xx/5xx, intentar leer mensaje de error
                    const errBody = await res.json().catch(() => ({}));
                    const msg = errBody.message || 'Error del servidor al autenticar.';
                    mostrarError(msg);
                    document.getElementById('password').value = '';
                    return;
                }

                const body = await res.json();

                // Se espera que la API retorne algo como: { success: true, role: 1 } o { success: false, message: '...' }
                if (!body || !body.success) {
                    mostrarError(body && body.message ? body.message : 'Credenciales incorrectas.');
                    document.getElementById('password').value = '';
                    return;
                }

                const rol = Number(body.role);
                const ruta = rutasPorRol[rol];

                if (ruta) {
                    // Redirigir según rol
                    window.location.href = ruta;
                } else {
                    mostrarError('Rol no tiene una página asignada.');
                }
            } catch (error) {
                console.error('Error al conectar con la API:', error);
                mostrarError('No se pudo conectar con el servidor. Verifica que la API esté en ejecución.');
            } finally {
                // Limpiar campo contraseña por seguridad
                document.getElementById('password').value = '';
            }
        });

        // Limpiar mensaje de error al escribir
        document.getElementById('username').addEventListener('input', function() {
            document.getElementById('errorMessage').style.display = 'none';
        });

        document.getElementById('password').addEventListener('input', function() {
            document.getElementById('errorMessage').style.display = 'none';
        });
    </script>
</body>
</html>